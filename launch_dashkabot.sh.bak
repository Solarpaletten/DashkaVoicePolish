#!/bin/zsh
# üöÄ DashkaBot Complete Launch Script
# –ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞

echo "üöÄ DashkaBot - –°–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞"
echo "====================================================="
echo "‚è∞ –ó–∞–ø—É—Å–∫: $(date '+%Y-%m-%d %H:%M:%S')"
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""

START_TIME=$(date +%s)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
show_progress() {
    local step=$1
    local total=$2
    local message=$3
    local elapsed=$(($(date +%s) - START_TIME))
    
    echo "[$step/$total] [${elapsed}s] $message"
    echo "$(printf '‚ñì%.0s' $(seq 1 $((step * 50 / total))))$(printf '‚ñë%.0s' $(seq 1 $((50 - step * 50 / total))))"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
check_status() {
    if [ $1 -eq 0 ]; then
        echo "‚úÖ $2"
    else
        echo "‚ùå $2"
        return 1
    fi
}

# =================== –®–ê–ì 1: –ü–†–û–í–ï–†–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø ===================
show_progress 1 10 "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è"

echo "üñ•Ô∏è  –°–∏—Å—Ç–µ–º–∞: $(uname -s) $(uname -r)"
echo "üè† –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Python
if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version)
    echo "‚úÖ Python: $PYTHON_VERSION"
else
    echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install python"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js
if command -v node &> /dev/null; then
    NODE_VERSION=$(node --version)
    echo "‚úÖ Node.js: $NODE_VERSION"
else
    echo "‚ùå Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install node"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ ADB
if command -v adb &> /dev/null; then
    ADB_VERSION=$(adb version | head -1)
    echo "‚úÖ ADB: $ADB_VERSION"
else
    echo "‚ùå ADB –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install android-platform-tools"
    exit 1
fi

# =================== –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í –ü–†–û–ï–ö–¢–ê ===================
show_progress 2 10 "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞:"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –ø–æ –æ–¥–Ω–æ–º—É
if [ -f "ai_server.py" ]; then
    echo "  ‚úÖ ai_server.py - AI —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤–æ–¥–æ–≤"
else
    echo "  ‚ùå ai_server.py - –û–¢–°–£–¢–°–¢–í–£–ï–¢"
    exit 1
fi

if [ -f "websocket_server.js" ]; then
    echo "  ‚úÖ websocket_server.js - WebSocket —Å–µ—Ä–≤–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
else
    echo "  ‚ùå websocket_server.js - –û–¢–°–£–¢–°–¢–í–£–ï–¢"
    exit 1
fi

if [ -f "dashkabot_web/index.html" ]; then
    echo "  ‚úÖ dashkabot_web/index.html - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
else
    echo "  ‚ùå dashkabot_web/index.html - –û–¢–°–£–¢–°–¢–í–£–ï–¢"
    exit 1
fi

if [ -f "config/dashkabot_config.json" ]; then
    echo "  ‚úÖ config/dashkabot_config.json - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã"
else
    echo "  ‚ùå config/dashkabot_config.json - –û–¢–°–£–¢–°–¢–í–£–ï–¢"
    exit 1
fi

if [ -f "DashkaBotAndroid/app/build.gradle" ]; then
    echo "  ‚úÖ DashkaBotAndroid/app/build.gradle - Android –ø—Ä–æ–µ–∫—Ç"
else
    echo "  ‚ùå DashkaBotAndroid/app/build.gradle - –û–¢–°–£–¢–°–¢–í–£–ï–¢"
    exit 1
fi
# =================== –®–ê–ì 3: –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô ===================
show_progress 3 10 "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"

echo "üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip3 install aiohttp aiohttp-cors asyncio --quiet
check_status $? "Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

echo "üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if [ ! -d "node_modules" ]; then
    npm install ws --silent
    check_status $? "Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚úÖ Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
fi

# =================== –®–ê–ì 4: –°–û–ó–î–ê–ù–ò–ï –õ–û–ì–û–í ===================
show_progress 4 10 "üìù –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"

mkdir -p logs run
touch logs/{ai_server,websocket_server,system}.log

echo "üìù –õ–æ–≥–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤:"
echo "  ‚Ä¢ logs/ai_server.log - AI —Å–µ—Ä–≤–µ—Ä"
echo "  ‚Ä¢ logs/websocket_server.log - WebSocket —Å–µ—Ä–≤–µ—Ä"
echo "  ‚Ä¢ logs/system.log - –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è"

# =================== –®–ê–ì 5: –ü–†–û–í–ï–†–ö–ê –ü–û–†–¢–û–í ===================
show_progress 5 10 "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–æ–≤"

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤:"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–æ—Ä—Ç
for port_info in "8080:AI Server" "8765:WebSocket Server" "8766:Stats Server" "8090:Web Interface"; do
    port=$(echo $port_info | cut -d: -f1)
    service=$(echo $port_info | cut -d: -f2)
    
    if lsof -i :$port &>/dev/null; then
        echo "  ‚ö†Ô∏è  –ü–æ—Ä—Ç $port –∑–∞–Ω—è—Ç ($service)"
        echo "     –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç..."
        lsof -ti :$port | xargs kill -9 2>/dev/null
        sleep 1
    fi
    echo "  ‚úÖ –ü–æ—Ä—Ç $port —Å–≤–æ–±–æ–¥–µ–Ω ($service)"
done
# =================== –®–ê–ì 6: –ó–ê–ü–£–°–ö AI –°–ï–†–í–ï–†–ê ===================
show_progress 6 10 "üß† –ó–∞–ø—É—Å–∫ AI —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤"

echo "üß† –ó–∞–ø—É—Å–∫ AI —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8080..."
python3 ai_server.py > logs/ai_server.log 2>&1 &
AI_PID=$!

sleep 3

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ AI —Å–µ—Ä–≤–µ—Ä–∞
if kill -0 $AI_PID 2>/dev/null; then
    echo "‚úÖ AI —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $AI_PID)"
    echo $AI_PID > run/ai_server.pid
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ AI —Å–µ—Ä–≤–µ—Ä–∞"
    cat logs/ai_server.log
    exit 1
fi

# =================== –®–ê–ì 7: –ó–ê–ü–£–°–ö WEBSOCKET –°–ï–†–í–ï–†–ê ===================
show_progress 7 10 "üåê –ó–∞–ø—É—Å–∫ WebSocket —Å–µ—Ä–≤–µ—Ä–∞"

echo "üåê –ó–∞–ø—É—Å–∫ WebSocket —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 8765/8766..."
node websocket_server.js > logs/websocket_server.log 2>&1 &
WS_PID=$!

sleep 3

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞
if kill -0 $WS_PID 2>/dev/null; then
    echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $WS_PID)"
    echo $WS_PID > run/websocket_server.pid
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞"
    cat logs/websocket_server.log
    exit 1
fi

# =================== –®–ê–ì 8: –ó–ê–ü–£–°–ö –í–ï–ë-–ò–ù–¢–ï–†–§–ï–ô–°–ê ===================
show_progress 8 10 "üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"

cd dashkabot_web
echo "üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8090..."
python3 -m http.server 8090 > ../logs/web_server.log 2>&1 &
WEB_PID=$!
cd ..

sleep 2

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
if kill -0 $WEB_PID 2>/dev/null; then
    echo "‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $WEB_PID)"
    echo $WEB_PID > run/web_server.pid
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
fi

# =================== –®–ê–ì 9: –ü–†–û–í–ï–†–ö–ê ANDROID –£–°–¢–†–û–ô–°–¢–í ===================
show_progress 9 10 "üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤"

echo "üì± –ü–æ–∏—Å–∫ Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤..."
adb start-server

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
devices=($(adb devices | tail -n +2 | grep -w "device" | cut -f1))
device_count=${#devices[@]}

echo "üìä –ù–∞–π–¥–µ–Ω–æ Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤: $device_count"

if [ $device_count -gt 0 ]; then
    echo "üì± –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
    for i in "${!devices[@]}"; do
        device=${devices[$i]}
        model=$(adb -s $device shell getprop ro.product.model 2>/dev/null | tr -d '\r\n')
        role=$([ $i -eq 0 ] && echo "Steuerberater üá©üá™" || echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å üá∑üá∫")
        echo "  üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ $((i+1)): $model ($device) ‚Üí $role"
    done
else
    echo "‚ö†Ô∏è  Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo "üí° –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"
fi

# =================== –®–ê–ì 10: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –°–¢–ê–¢–£–° ===================
show_progress 10 10 "üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."

# AI Server
if curl -s http://localhost:8080/health > /dev/null; then
    AI_STATUS="‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç"
else
    AI_STATUS="‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# WebSocket Server
if curl -s http://localhost:8766/health > /dev/null; then
    WS_STATUS="‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç"
else
    WS_STATUS="‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# Web Interface
if curl -s http://localhost:8090 > /dev/null; then
    WEB_STATUS="‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç"
else
    WEB_STATUS="‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# –ü–æ–ª—É—á–∞–µ–º IP –∞–¥—Ä–µ—Å
LOCAL_IP=$(ifconfig | grep 'inet ' | grep -v 127.0.0.1 | head -1 | awk '{print $2}')

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å—Ç–∞—Ç—É—Å–∞
cat > system_status.json << EOF
{
  "launch_time": "$(date -Iminutes)",
  "startup_duration": $(($(date +%s) - START_TIME)),
  "system_status": "active",
  "local_ip": "$LOCAL_IP",
  "services": {
    "ai_server": {
      "pid": $AI_PID,
      "port": 8080,
      "status": "$AI_STATUS",
      "url": "http://localhost:8080"
    },
    "websocket_server": {
      "pid": $WS_PID,
      "port": 8765,
      "stats_port": 8766,
      "status": "$WS_STATUS",
      "url": "ws://localhost:8765"
    },
    "web_interface": {
      "pid": $WEB_PID,
      "port": 8090,
      "status": "$WEB_STATUS",
      "url": "http://localhost:8090"
    }
  },
  "android_devices": {
    "count": $device_count,
    "devices": [$(printf '"%s",' "${devices[@]}" | sed 's/,$//')],
    "ready": $([ $device_count -gt 0 ] && echo "true" || echo "false")
  }
}
EOF

END_TIME=$(date +%s)
TOTAL_TIME=$((END_TIME - START_TIME))

echo ""
echo "üéØ ===== DASHKABOT –°–ò–°–¢–ï–ú–ê –ó–ê–ü–£–©–ï–ù–ê ====="
echo "‚è∞ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: $TOTAL_TIME —Å–µ–∫—É–Ω–¥"
echo "üìç IP –∞–¥—Ä–µ—Å: $LOCAL_IP"
echo ""

echo "üìä –°–¢–ê–¢–£–° –°–ï–†–í–ò–°–û–í:"
echo "üß† AI Server (8080): $AI_STATUS"
echo "üåê WebSocket (8765): $WS_STATUS"  
echo "üì± Web Interface (8090): $WEB_STATUS"
echo "üì± Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤: $device_count"
echo ""

echo "üîó –î–û–°–¢–£–ü–ù–´–ï –ò–ù–¢–ï–†–§–ï–ô–°–´:"
echo "‚Ä¢ üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://$LOCAL_IP:8090"
echo "‚Ä¢ üîß AI API: http://localhost:8080/health"
echo "‚Ä¢ üìä WebSocket Stats: http://localhost:8766/stats"
echo ""

echo "üì± –î–õ–Ø ANDROID –£–°–¢–†–û–ô–°–¢–í:"
echo "1. üåê –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ"
echo "2. üìù –í–≤–µ–¥–∏—Ç–µ: http://$LOCAL_IP:8090"
echo "3. üé§ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –∏ –Ω–∞—á–∏–Ω–∞–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å!"
echo ""

echo "üì± –î–õ–Ø PWA –£–°–¢–ê–ù–û–í–ö–ò:"
echo "1. üåê –û—Ç–∫—Ä–æ–π—Ç–µ http://$LOCAL_IP:8090 –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "2. ‚ãÆ –ú–µ–Ω—é ‚Üí '–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω'"
echo "3. üì± DashkaBot —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
echo ""

echo "üéØ –ì–û–¢–û–í–´–ï –§–†–ê–ó–´ –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:"
echo "üá∑üá∫ –†—É—Å—Å–∫–∏–π: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å, –º–Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –Ω–∞–ª–æ–≥–∞–º–∏'"
echo "üá©üá™ –ù–µ–º–µ—Ü–∫–∏–π: 'Guten Tag, wie kann ich Ihnen helfen?'"
echo ""

echo "üîß –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–û–ô:"
echo "‚Ä¢ üìä –°—Ç–∞—Ç—É—Å: cat system_status.json"
echo "‚Ä¢ üìù –õ–æ–≥–∏: tail -f logs/*.log"
echo "‚Ä¢ üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: kill $AI_PID $WS_PID $WEB_PID"
echo "‚Ä¢ üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: ./$(basename $0)"
echo ""

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
cat > stop_dashkabot.sh << 'EOF'
#!/bin/zsh
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ DashkaBot —Å–∏—Å—Ç–µ–º—ã..."

# –ß–∏—Ç–∞–µ–º PID —Ñ–∞–π–ª—ã –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
for pid_file in run/*.pid; do
    if [ -f "$pid_file" ]; then
        pid=$(cat "$pid_file")
        service=$(basename "$pid_file" .pid)
        
        if kill -0 $pid 2>/dev/null; then
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ $service (PID: $pid)"
            kill $pid
            rm "$pid_file"
        fi
    fi
done

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –ø–æ—Ä—Ç–∞–º
for port in 8080 8765 8766 8090; do
    if lsof -ti :$port &>/dev/null; then
        echo "üîå –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞ $port"
        lsof -ti :$port | xargs kill -9 2>/dev/null
    fi
done

echo "‚úÖ DashkaBot —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
EOF

chmod +x stop_dashkabot.sh

echo "üéâ ===== –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ ====="
echo ""
echo "üá©üá™‚ÜîÔ∏èüá∑üá∫ –ü–û–ï–•–ê–õ–ò, –°–ï–ù–¨–û–†! –ú–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å Steuerberater!"
echo ""
echo "üí° –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∏—Å—Ç–µ–º—ã: ./stop_dashkabot.sh"

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if command -v open &> /dev/null; then
    echo "üåê –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞..."
    sleep 2
    open "http://localhost:8090"
fi

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
if [ $device_count -gt 0 ]; then
    echo ""
    echo "üì± –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –Ω–∞ Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö..."
    for device in "${devices[@]}"; do
        adb -s $device shell am start -a android.intent.action.VIEW -d "http://$LOCAL_IP:8090" 2>/dev/null
    done
fi

echo ""
echo "üìä –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–ø—É—â–µ–Ω–∞. –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:"
echo "tail -f logs/system.log"